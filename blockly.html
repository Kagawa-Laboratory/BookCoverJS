<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Blockly for BookCoverJS</title>
<script src="3rdParty/blockly/blockly_compressed.js"></script>
<script src="3rdParty/blockly/blocks_compressed.js"></script>
<script src="3rdParty/blockly/javascript_compressed.js"></script>
<script src="3rdParty/blockly/demos/prettify.js"></script>
<!-- script src="3rdParty/blockly/msg/js/en.js"></script-->
<script src="3rdParty/blockly/msg/js/ja.js"></script>
<link rel="stylesheet" type="text/css" href="3rdParty/blockly/demos/prettify.css">
<script src="myblocks.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
<style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: sans-serif;
      overflow: hidden;
    }
    table {
      height: 100%;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      padding: 0;
      border: none;
    }

    /* Tabs */
    #tabRow>td {
      border: 1px solid #ccc;
      border-bottom: none;
    }
    td.tabon {
      border-bottom-color: #ddd !important;
      background-color: #ddd;
      padding: 5px 19px;
    }
    td.taboff {
      cursor: pointer;
      padding: 5px 19px;
    }
    td.taboff:hover {
      background-color: #eee;
    }
    td.tabmin {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
    }
    td.tabmax {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
      width: 99%;
      padding-left: 10px;
      padding-right: 10px;
      text-align: right;
    }

    .content {
      visibility: hidden;
      margin: 0;
      padding: 1ex;
      position: absolute;
      direction: ltr;
    }
    pre.content {
      border: 1px solid #ccc;
      overflow: scroll;
    }
</style>
</head>
<body>
<xml id="toolbox" style="display: none">
<category name="ブックカバー（基本）">
  <block type="bookcover_frame"></block>
  <block type="bookcover_guide_bars"></block>
  <block type="bookcover_matrix"></block>
  <block type="bookcover_fill"></block>
  <block type="bookcover_no_fill"></block>
  <block type="bookcover_fill_opacity"></block>
  <block type="bookcover_stroke"></block>
  <block type="bookcover_no_stroke"></block>
  <block type="bookcover_stroke_weight"></block>
  <block type="bookcover_stroke_opacity"></block>
  <block type="bookcover_text_font">
  <value name="name">
  <block type="bookcover_font_name"></block>
  </value>
  <value name="size">
  <block type="math_number"></block>
  </value>
  </block>
  <block type="bookcover_random_seed"></block>
  <block type="bookcover_random_in_range"></block>
  <block type="bookcover_translate"></block>
  <block type="bookcover_scale"></block>
  <block type="bookcover_rotate"></block>
</category>
<category name="ブックカバー（基本図形）">
  <block type="bookcover_line"></block>
  <block type="bookcover_rect"></block>
  <block type="bookcover_ellipse"></block>
  <block type="bookcover_text"></block>
</category>
<category name="ブックカバー（色・角度）">
  <block type="bookcover_colour"></block>
  <block type="bookcover_rotate_h"></block>
  <block type="bookcover_angle"></block>
  <block type="bookcover_rgb255"></block>
  <block type="bookcover_hsb360"></block>
  <block type="bookcover_hsl360"></block>
  <block type="bookcover_font_name"></block>
</category>
<category name="&#128034; タートル">
  <block type="bookcover_pen_up"></block>
  <block type="bookcover_pen_down"></block>
  <block type="bookcover_forward"></block>
  <block type="bookcover_turn"></block>
  <block type="bookcover_direction"></block>
  <block type="bookcover_go"></block>
  <block type="bookcover_say"></block>
</category>
<category name="流れ" colour="120">
  <block type="controls_if"></block>
  <block type="controls_repeat_ext"></block>
  <block type="controls_whileUntil"></block>
  <block type="controls_for"></block>
  <block type="controls_forEach"></block>
  <block type="controls_flow_statements"></block>
</category>
<category name="数・文字列・演算" colour="330">
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="math_number"></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property">
        <value name="NUMBER_TO_CHECK">
          <shadow type="math_number">
            <field name="NUM">0</field>
          </shadow>
        </value>
      </block>
      <block type="math_round">
        <value name="NUM">
          <shadow type="math_number">
            <field name="NUM">3.1</field>
          </shadow>
        </value>
      </block>
      <block type="math_modulo">
        <value name="DIVIDEND">
          <shadow type="math_number">
            <field name="NUM">64</field>
          </shadow>
        </value>
        <value name="DIVISOR">
          <shadow type="math_number">
            <field name="NUM">10</field>
          </shadow>
        </value>
      </block>
      <block type="math_constrain">
        <value name="VALUE">
          <shadow type="math_number">
            <field name="NUM">50</field>
          </shadow>
        </value>
        <value name="LOW">
          <shadow type="math_number">
            <field name="NUM">1</field>
          </shadow>
        </value>
        <value name="HIGH">
          <shadow type="math_number">
            <field name="NUM">100</field>
          </shadow>
        </value>
      </block>
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_join"></block>
      <block type="text_append"></block>
      <block type="text_print"></block>
      <block type="text_prompt_ext"></block>
      <block type="text_charAt"></block>
    </category>
    <category name="リスト">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM">
          <block type="math_number">
            <field name="NUM">5</field>
          </block>
        </value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
    </category>
    <category name="変数" custom="VARIABLE"></category>
    <category name="関数" custom="PROCEDURE"></category>
</xml>
<table>
<tr>
    <td>
       <table width='100%'>
          <tr id="tabRow" height="1em">
            <td id="tabBlocks" class="tabon" style="white-space:nowrap;">ブロック</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabJavaScript" class="taboff" style="white-space:nowrap;">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabXml" class="taboff" style="white-space:nowrap;">(管理用)</td>
            <td class="tabmax">
              <button id="runButton" class="notext primary" title="...">
                &#x23f5;
              </button>
            </td>
          </tr>
       </table>
    </td>
</tr>
<tr>
  <td id="blocklyArea" style='border: 0pt; height: 99%;'> 
  </td>  
</tr>
</table>
<div id="contentBlock" style="position: absolute;"></div>
<pre id="contentJavaScript" class="content"></pre>
<pre id="contentXml"  class="content"></pre>
<script>
var tabs = ["Blocks", "JavaScript", "Xml"]; 
var selected = tabs[0];

function onResize() {
    var area = $("#blocklyArea");
    var divs = [ $("#contentBlock"), $("#contentJavaScript"), $("#contentXml") ];

    var width = area.width();
    var height = area.height();
    var offset = area.offset();
    for (var i = 0; i < divs.length ; i++) {
       var div = divs[i]; 
       div.height(height);
       div.width(width);
       div.offset(offset);
    }
}

var workspace = null;

function renderContent(clickedName) {
  var content = $("#content" + clickedName); 
  if (clickedName == "Xml") {
    var xmlDom = Blockly.Xml.workspaceToDom(workspace);
    var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
    content.text(xmlText);
  } else if (clickedName == "JavaScript") {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    content.html(code);

      code = content.html();
      code = prettyPrintOne(code, 'js');
      content.html(code);

  } 
}

function tabClick(clickedName) {
  if ($("#tabBlocks").hasClass('tabon')) {
    workspace.setVisible(false);
  }

  // Deselect all tabs and hide all panes.
  for (var i = 0; i < tabs.length; i++) {
    var name = tabs[i];
    $('#tab' + name).removeClass('tabon');
    $('#tab' + name).addClass('taboff');
    $('#content' + name).css("visibility", 'hidden');
  }

  // Select the active tab.
  selected = clickedName;
  $('#tab' + clickedName).removeClass('taboff');
  $('#tab' + clickedName).addClass('tabon');
  $('#content' + clickedName).css("visibility", 'visible');

  renderContent(clickedName);

  if (clickedName == 'Blocks') {
    workspace.setVisible(true);
  }
  Blockly.svgResize(workspace);
}

$(window).on('load resize', onResize);


$(function() {
    workspace = Blockly.inject('contentBlock',
                                   { toolbox: document.getElementById('toolbox') });
    $("#runButton").click(function () {
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        alert(code);
    });
    onResize();
    Blockly.svgResize(workspace);

    // 無理やりフォントを変更する。
    var cssNode = document.createElement('style');
    document.head.appendChild(cssNode);
    var text = ".blocklyText {"
      	     + "  cursor: default;"
      	     + "  fill: #fff;"
      	     + "  font-family: 'Segoe UI Symbol';"
      	     + "  font-size: 11pt;"
      	     + "}";
    var cssTextNode = document.createTextNode(text);
    cssNode.appendChild(cssTextNode);

    tabClick(selected);
    for (var i = 0; i < tabs.length; i++) {
       var name = tabs[i];
       $("#tab" + name).click(function(name_) { return function() { tabClick(name_); }; }(name));
    }
});
</script>
</body>
</html>
