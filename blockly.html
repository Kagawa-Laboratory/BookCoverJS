<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Blockly for BookCoverJS</title>
<link rel="shortcut icon" href="favicon.png" type="image/png"/>
<script src="3rdParty/blockly/blockly_compressed.js"></script>
<script src="3rdParty/blockly/blocks_compressed.js"></script>
<script src="3rdParty/blockly/javascript_compressed.js"></script>
<!--<script src="3rdParty/blockly/demos/prettify.js"></script>-->
<script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
<!-- script src="3rdParty/blockly/msg/js/en.js"></script-->
<script src="3rdParty/blockly/msg/js/ja.js"></script>
<script src="3rdParty/blockly/appengine/storage.js"></script>
<link rel="stylesheet" type="text/css" href="3rdParty/blockly/demos/prettify.css">
<script src="myblockly.js"></script>
<script src="myblocks.js"></script>
<!--
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
-->
<script src="3rdParty/jquery-2.2.4.min.js"></script>
<script src="3rdParty/jquery.query.js"></script>
<script src="3rdParty/intro.js"></script>
<link rel="stylesheet" href="3rdParty/introjs.css"/>
<script src="3rdParty/svg.js"></script>
<script src="BookCoverJS/BookCover.js"></script>
<style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: sans-serif;
      overflow: hidden;
    }
    table {
      height: 100%;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      padding: 0;
      border: none;
    }

    /* Tabs */
    #tabRow>td {
      border: 1px solid #ccc;
      border-bottom: none;
    }
    td.tabon {
      border-bottom-color: #ddd !important;
      background-color: #ddd;
      padding: 5px 19px;
    }
    td.taboff {
      cursor: pointer;
      padding: 5px 19px;
    }
    td.taboff:hover {
      background-color: #eee;
    }
    td.tabmin {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
    }
    td.tabmax {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
      width: 99%;
      padding-left: 10px;
      padding-right: 10px;
      text-align: right;
    }

    .content {
      visibility: hidden;
      margin: 0;
      padding: 1ex;
      position: absolute;
      direction: ltr;
    }
    pre.content {
      border: 1px solid #ccc;
      overflow: scroll;
    }
    div.content {
      border: 1px solid #ccc;
      overflow: scroll;
    }

    .button_like {
      font-size: 70%;
      font-family: 'Segoe UI Emoji';
      padding: 3px 5px 3px 5px;
      text-align: center;
      text-decoration: none;
      border: 2px solid;
      border-color: #aaaaaa #444444 #444444 #aaaaaa;
      background: #dddddd;
    }

    .button_like:hover{
      background:#ccddff;
      border-color: #aaaacc #444466 #444466 #aaaacc;
    }
</style>
</head>
<body>
<xml id="toolbox" style="display: none">
<category name="基本設定" colour="100">
  <block type="bookcover_card_frame">
    <value name="PAPER_SPEC">
      <block type="bookcover_cardspec">
        <field name="CARDSPEC">エーワン F8A4-5</field>
      </block>
    </value>
    <statement name="DO">
      <block type="bookcover_foreachcard">
        <field name="CARD">カード</field>
        <field name="COUNTER">カウンター</field>
      </block>
    </statement>
  </block>
  <block type="bookcover_frame"></block>
  <block type="bookcover_rulers"></block>
  <block type="bookcover_guide_bars">
    <value name="width">
      <block type="math_number">
        <field name="NUM">0.1</field>
      </block>
    </value>
  </block>
  <block type="bookcover_foreachcard"></block>
  <block type="bookcover_cardspec"></block>
  <block type="bookcover_pageWidth"></block>
  <block type="bookcover_pageHeight"></block>
  <block type="bookcover_cardWidth">
    <value name="CARD">
      <block type="variables_get">
        <field name="VAR">カード</field>
      </block>
    </value>
  </block>
  <block type="bookcover_cardHeight">
    <value name="CARD">
      <block type="variables_get">
        <field name="VAR">カード</field>
      </block>
    </value>
  </block>
</category>
<category name="色" colour="20">
  <block type="bookcover_fill">
    <value name="COLOUR">
      <block type="bookcover_colour">
        <field name="COLOUR">#ff0000</field>
      </block>
    </value>
  </block>
  <block type="bookcover_fill_opacity">
    <value name="opacity">
      <block type="math_number">
        <field name="NUM">0.5</field>
      </block>
    </value>
  </block>
  <block type="bookcover_stroke">
      <value name="COLOUR">
      <block type="bookcover_colour">
        <field name="COLOUR">#ff0000</field>
      </block>
    </value>
  </block>
  <block type="bookcover_stroke_weight">
    <value name="width">
      <block type="math_number">
        <field name="NUM">1</field>
      </block>
    </value>
  </block>
  <block type="bookcover_stroke_opacity">
    <value name="opacity">
      <block type="math_number">
        <field name="NUM">0.5</field>
      </block>
    </value>
  </block>
  <block type="bookcover_colour"></block>
  <block type="bookcover_none"></block>
  <block type="bookcover_rotate_h">
    <value name="colour">
      <block type="bookcover_colour">
        <field name="COLOUR">#ff0000</field>
      </block>
    </value>
    <value name="angle">
      <block type="bookcover_angle">
        <field name="angle">120</field>
      </block>
    </value>
  </block>
  <block type="bookcover_add_s">
    <value name="colour">
      <block type="bookcover_colour">
        <field name="COLOUR">#ff0000</field>
      </block>
    </value>
    <value name="delta">
      <block type="math_number">
        <field name="NUM">-10</field>
      </block>
    </value>
  </block>
  <block type="bookcover_add_l">
    <value name="colour">
      <block type="bookcover_colour">
        <field name="COLOUR">#ff0000</field>
      </block>
    </value>
    <value name="delta">
      <block type="math_number">
        <field name="NUM">-10</field>
      </block>
    </value>
  </block>
  <block type="bookcover_rgb100">
    <value name="red">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="green">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
    <value name="blue">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
  </block>
  <block type="bookcover_hsl360">
    <value name="hue">
      <block type="bookcover_angle">
        <field name="angle">180</field>
      </block>
    </value>
    <value name="saturation">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
    <value name="luminance">
      <block type="math_number">
        <field name="NUM">50</field>
      </block>
    </value>
  </block>
</category>
<category name="文字列" colour="160">
  <block type="bookcover_text_font">
    <value name="name">
      <block type="bookcover_font_name">
        <field name="NAME">ＭＳ 明朝</field>
      </block>
    </value>
    <value name="size">
      <block type="math_number">
        <field name="NUM">12</field>
      </block>
    </value>
  </block>
  <block type="bookcover_text">
    <value name="x">
      <block type="math_number">
        <field name="NUM">10</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="str">
      <block type="text">
        <field name="TEXT">こんにちは</field>
      </block>
    </value>
  </block>
  <block type="bookcover_font_name"></block>
  <block type="text">
   <field name="TEXT">&#x1f345;&#x1f346;&#x1f347;&#x1f34a;&#x1f34d;&#x1f34e;&#x1f350;&#x1f351;</field>
  </block>
  <block type="bookcover_newline"></block>
  <block type="text_length"></block>
  <block type="bookcover_fromCodePoint"></block>
  <block type="text_join"></block>
  <block type="text_append"></block>
  <block type="text_print"></block>
  <block type="text_prompt_ext"></block>
  <block type="text_charAt"></block>
</category>
<category name="移動・拡大／縮小・回転"  colour="0">
  <block type="bookcover_matrix"></block>
  <block type="bookcover_translate">
    <value name="x">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">-25</field>
      </block>
    </value>
  </block>
  <block type="bookcover_scale">
    <value name="x">
      <block type="math_number">
        <field name="NUM">1.5</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">2.9</field>
      </block>
    </value>
  </block>
    <block type="bookcover_rotate">
    <value name="angle">
      <block type="bookcover_angle">
        <field name="angle">45</field>
      </block>
    </value>
  </block>
  <block type="bookcover_angle"></block>
</category>
<category name="基本図形" colour="130">
    <block type="bookcover_line">
    <value name="x1">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="y1">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="x2">
      <block type="math_number">
        <field name="NUM">50</field>
      </block>
    </value>
    <value name="y2">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
  </block>
  <block type="bookcover_rect">
    <value name="x">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="w">
      <block type="math_number">
        <field name="NUM">120</field>
      </block>
    </value>
    <value name="h">
      <block type="math_number">
        <field name="NUM">230</field>
      </block>
    </value>
  </block>
  <block type="bookcover_ellipse">
    <value name="x">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="w">
      <block type="math_number">
        <field name="NUM">120</field>
      </block>
    </value>
    <value name="h">
      <block type="math_number">
        <field name="NUM">230</field>
      </block>
    </value>
  </block>
  <block type="bookcover_triangle">
    <value name="x1">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y1">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="x2">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y2">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="x3">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="y3">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
  </block>
  <block type="bookcover_quad">
    <value name="x1">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y1">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="x2">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="y2">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="x3">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="y3">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="x4">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y4">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
  </block>
  <block type="bookcover_arc">
    <value name="x">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="w">
      <block type="math_number">
        <field name="NUM">120</field>
      </block>
    </value>
    <value name="h">
      <block type="math_number">
        <field name="NUM">230</field>
      </block>
    </value>
    <value name="start">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="end">
      <block type="math_number">
        <field name="NUM">60</field>
      </block>
    </value>
  </block>
  <block type="bookcover_image">
    <value name="x">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="w">
      <block type="math_number">
        <field name="NUM">16</field>
      </block>
    </value>
    <value name="h">
      <block type="math_number">
        <field name="NUM">16</field>
      </block>
    </value>
    <value name="url">
      <block type="text">
        <field name="TEXT">http://guppy.eng.kagawa-u.ac.jp/OpenCampus/favicon.png</field>
      </block>
    </value>
  </block>
  <block type="bookcover_bezier">
    <value name="x1">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y1">
      <block type="math_number">
        <field name="NUM">15</field>
      </block>
    </value>
    <value name="x2">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="y2">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="x3">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="y3">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="x4">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
    <value name="y4">
      <block type="math_number">
        <field name="NUM">20</field>
      </block>
    </value>
  </block>
</category>
<category name="数" colour="230">
  <block type="bookcover_random_seed">
    <value name="seed">
      <block type="math_number">
        <field name="NUM">123456</field>
      </block>
    </value>
  </block>
  <block type="bookcover_random_in_range">
    <value name="min">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="max">
      <block type="math_number">
        <field name="NUM">1</field>
      </block>
    </value>
  </block>
  <block type="math_number"></block>
  <block type="math_arithmetic"></block>
  <block type="math_single"></block>
  <block type="math_trig"></block>
  <block type="math_constant"></block>
  <block type="math_number_property">
    <value name="NUMBER_TO_CHECK">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
  </block>
  <block type="math_round">
    <value name="NUM">
      <shadow type="math_number">
        <field name="NUM">3.1</field>
      </shadow>
    </value>
  </block>
  <block type="math_modulo">
    <value name="DIVIDEND">
      <shadow type="math_number">
        <field name="NUM">64</field>
      </shadow>
    </value>
    <value name="DIVISOR">
      <shadow type="math_number">
        <field name="NUM">10</field>
      </shadow>
    </value>
  </block>
  <block type="math_constrain">
    <value name="VALUE">
      <shadow type="math_number">
        <field name="NUM">50</field>
      </shadow>
    </value>
    <value name="LOW">
      <shadow type="math_number">
        <field name="NUM">1</field>
      </shadow>
    </value>
    <value name="HIGH">
      <shadow type="math_number">
        <field name="NUM">100</field>
      </shadow>
    </value>
  </block>
  <block type="bookcover_distance">
    <value name="X1">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
    <value name="Y1">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
    <value name="X2">
      <shadow type="math_number">
        <field name="NUM">3</field>
      </shadow>
    </value>
    <value name="Y2">
      <shadow type="math_number">
        <field name="NUM">4</field>
      </shadow>
    </value>
  </block>
  <block type="bookcover_atan2">
    <value name="X1">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
    <value name="Y1">
      <shadow type="math_number">
        <field name="NUM">0</field>
      </shadow>
    </value>
    <value name="X2">
      <shadow type="math_number">
        <field name="NUM">3</field>
      </shadow>
    </value>
    <value name="Y2">
      <shadow type="math_number">
        <field name="NUM">4</field>
      </shadow>
    </value>
  </block>
</category>
<category name="&#128034; かめ" colour="150">
  <block type="bookcover_pen_down"></block>
  <block type="bookcover_pen_up"></block>
  <block type="bookcover_forward">
    <value name="len">
      <block type="math_number">
        <field name="NUM">50</field>
      </block>
    </value>
  </block>
  <block type="bookcover_turn">
    <value name="angle">
      <block type="bookcover_angle">
        <field name="angle">72</field>
      </block>
    </value>
  </block>
  <block type="bookcover_direction">
    <value name="angle">
      <block type="bookcover_angle">
        <field name="angle">144</field>
      </block>
    </value>
  </block>
  <block type="bookcover_go">
    <value name="x">
      <block type="math_number">
        <field name="NUM">50</field>
      </block>
    </value>
    <value name="y">
      <block type="math_number">
        <field name="NUM">75</field>
      </block>
    </value>
  </block>
  <block type="bookcover_say">
    <value name="str">
      <block type="text">
        <field name="TEXT">こんにちは</field>
      </block>
    </value>
  </block>
  <block type="bookcover_get_x"></block>
  <block type="bookcover_get_y"></block>
  <block type="bookcover_get_angle"></block>
</category>
<category name="論理" colour="210">
  <block type="controls_if">
    <value name="IF0">
      <block type="logic_boolean">
        <field name="BOOL">TRUE</field>
      </block>
    </value>
  </block>
  <block type="controls_if">
    <mutation else="1"></mutation>
    <value name="IF0">
      <block type="logic_boolean">
        <field name="BOOL">TRUE</field>
      </block>
    </value>
  </block>
  <block type="logic_compare"></block>
  <block type="logic_operation"></block>
  <block type="logic_negate"></block>
  <block type="logic_boolean"></block>
</category>
<category name="繰り返し" colour="120">
  <block type="controls_repeat_ext">
    <value name="TIMES">
      <block type="math_number">
        <field name="NUM">4</field>
      </block>
    </value>
  </block>
  <block type="controls_for">
    <field name="VAR">i</field>
    <value name="FROM">
      <block type="math_number">
        <field name="NUM">5</field>
      </block>
    </value>
    <value name="TO">
      <block type="math_number">
        <field name="NUM">25</field>
      </block>
    </value>
    <value name="BY">
      <block type="math_number">
        <field name="NUM">4</field>
      </block>
    </value>
  </block>
  <block type="controls_whileUntil">
    <field name="MODE">WHILE</field>
    <value name="BOOL">
      <block type="logic_boolean">
        <field name="BOOL">TRUE</field>
      </block>
    </value>
  </block>
  <block type="controls_forEach">
    <field name="VAR">i</field>
    <value name="LIST">
      <block type="lists_create_with">
        <mutation items="3"></mutation>
        <value name="ADD0">
          <block type="math_number">
            <field name="NUM">2</field>
          </block>
        </value>
        <value name="ADD1">
          <block type="math_number">
            <field name="NUM">3</field>
          </block>
        </value>
        <value name="ADD2">
          <block type="math_number">
            <field name="NUM">5</field>
          </block>
        </value>
      </block>
    </value>
  </block>
  <block type="controls_flow_statements"></block>
</category>
<category name="リスト" colour="260">
  <block type="lists_create_empty"></block>
  <block type="lists_create_with"></block>
  <block type="lists_repeat">
    <value name="NUM">
      <block type="math_number">
        <field name="NUM">5</field>
      </block>
    </value>
  </block>
  <block type="lists_length"></block>
  <block type="lists_isEmpty"></block>
  <block type="lists_indexOf"></block>
  <block type="lists_getIndex"></block>
  <block type="lists_setIndex"></block>
</category>
<category name="変数" custom="VARIABLE" colour="330"></category>
<category name="関数" custom="PROCEDURE" colour="290"></category>
<category name="（上級者用）">
  <block type="bookcover_generic_statement"></block>
  <block type="bookcover_generic_expression"></block>
  <block type="bookcover_rgb255">
    <value name="red">
      <block type="math_number">
        <field name="NUM">0</field>
      </block>
    </value>
    <value name="green">
      <block type="math_number">
        <field name="NUM">255</field>
      </block>
    </value>
    <value name="blue">
      <block type="math_number">
        <field name="NUM">255</field>
      </block>
    </value>
  </block>
  <block type="bookcover_hsb360">
    <value name="hue">
      <block type="bookcover_angle">
        <field name="angle">300</field>
      </block>
    </value>
    <value name="saturation">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
    <value name="brightness">
      <block type="math_number">
        <field name="NUM">100</field>
      </block>
    </value>
  </block>
  <block type="bookcover_console_log"></block>
</category>
</xml>

<xml id="startBlocks" style="display: none;">
  <block type="bookcover_frame" x="147" y="61">
    <statement name="statements">
      <block type="bookcover_guide_bars">
        <value name="width">
          <block type="math_number">
            <field name="NUM">0.5</field>
          </block>
        </value>
        <next>
          <block type="bookcover_stroke">
            <value name="COLOUR">
              <block type="bookcover_colour">
                <field name="COLOUR">#ff0000</field>
              </block>
            </value>
            <next>
              <block type="bookcover_fill">
                <value name="COLOUR">
                  <block type="bookcover_none"></block>
                </value>
                <next>
                  <block type="bookcover_ellipse">
                    <value name="x">
                      <block type="math_number">
                        <field name="NUM">0</field>
                      </block>
                    </value>
                    <value name="y">
                      <block type="math_number">
                        <field name="NUM">0</field>
                      </block>
                    </value>
                    <value name="w">
                      <block type="math_number">
                            <field name="NUM">100</field>
                  </block>
                    </value>
                    <value name="h">
                      <block type="math_number">
                        <field name="NUM">200</field>
                      </block>
                    </value>
                  </block>
                </next>
              </block>
            </next>
          </block>
        </next>
      </block>
    </statement>
  </block>
</xml>

<table>
<tr>
    <td>
       <table width='100%'>
          <tr id="tabRow" height="1em">
            <td id="tabBlocks" class="tabon" style="white-space:nowrap;" data-step="1" data-intro="このタブをクリックして、編集をはじめます。">ブロック</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabJavaScript" class="taboff" style="white-space:nowrap;">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabSVG" class="taboff" style="white-space:nowrap;" data-step="2" data-intro="このタブをクリックして、絵を確認します。">絵</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabXml" class="taboff" style="font-family:'Segoe UI Emoji'; white-space:nowrap;">(管理者用)</td>
            <td class="tabmax">
              <a href="#" id="intro" title="ヘルプ" class="i18n button_like">&#x2753;</a>
              <a href="#" id="openButton" title="読込み" class="i18n button_like" data-step="5"
                          data-intro="保存したプログラムを読み込みます。">&#x1f4c2;</a>
              <input type="file" id="openButtonAux" name="openButtonAux"  style="display:none;" />
              <a href="#" id="saveButton" download="blocks.xml" title="保存" class="i18n button_like" data-step="4"
                          data-intro="プログラムを保存します。">&#x1f4be;</a>
              <a href="#" id="printButton" title="印刷用ページ" class="i18n button_like" data-step="6"
                          data-intro="印刷用ページを開きます。">&#x1f5a8;</a>
              <a href="#" id="uploadSvgButton" title="絵をアップロード"
                          class="i18n button_like" data-step="8">&#x1f5bc;&#x1f4e4;</a>
              <a href="#" id="uploadXmlButton" title="データ (XML) をアップロード"
                          class="i18n button_like" data-step="8">&#x1f4c4;&#x1f4e4;</a>
              <a href="#" id="resetButton" title="リセット" class="i18n button_like" data-step="7"
                          data-intro="これまでの変更を捨てて、最初のプログラムに戻します。">&#x21bb;</a>
            </td>
          </tr>
       </table>
    </td>
</tr>
<tr>
  <td id="blocklyArea" style='border: 0pt; height: 99%;'>
  </td>
</tr>
</table>
<div id="contentBlock" style="position: absolute;"></div>
<pre id="contentJavaScript" class="content"></pre>
<div id="contentSVG"  class="content" style="padding: 0ex;"></div>
<textarea id="contentXml" class="content" wrap="off"></textarea>
<script>
var tabs = ["Blocks", "JavaScript", "SVG", "Xml"];
var selected = tabs[0];
var draw;
var workspace = null;

function onResize() {
    var area = $("#blocklyArea");
    var divs = [ $("#contentBlock"), $("#contentJavaScript"), $("#contentSVG"), $("#contentXml") ];

    var width = area.width();
    var height = area.height();
    var offset = area.offset();
    for (var i = 0; i < divs.length ; i++) {
       var div = divs[i];
       div.height(height);
       div.width(width);
       div.offset(offset);
    }
}

$(window).on('load resize', onResize);

function renderSVG() {
  var code = Blockly.JavaScript.workspaceToCode(workspace);
  draw.clear();
  BookCover.init();
  eval(code);
}

function renderContent(clickedName) {
  var content = $("#content" + clickedName);
  if (clickedName == "Xml") {
    var xmlDom  = Blockly.Xml.workspaceToDom(workspace);
    var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
    content.val(xmlText);
  } else if (clickedName == "JavaScript") {
    var code = Blockly.JavaScript.workspaceToCode(workspace);
    content.html(code);

    // TODO: CodeMirror
    code = content.html();
    code = prettyPrintOne(code, 'js');
    content.html(code);
  } else if (clickedName == "SVG") {
    renderSVG();
  }
}

function tabClick(clickedName) {
  // If the XML tab was open, save and render the content.
  if ($('#tabXml').hasClass('tabon')) {
    var xmlTextarea = $('#contentXml');
    var xmlText = xmlTextarea.val();
    var xmlDom = null;
    try {
      xmlDom = Blockly.Xml.textToDom(xmlText);
    } catch (e) {
      var q = window.confirm(MSG['badXml'].replace('%1', e));
      if (!q) {
        // Leave the user on the XML tab.
        return;
      }
    }
    if (xmlDom) {
      workspace.clear();
      Blockly.Xml.domToWorkspace(xmlDom, workspace);
    }
  }

  if ($("#tabBlocks").hasClass('tabon')) {
    workspace.setVisible(false);
  }

  // Deselect all tabs and hide all panes.
  for (var i = 0; i < tabs.length; i++) {
    var name = tabs[i];
    $('#tab' + name).removeClass('tabon');
    $('#tab' + name).addClass('taboff');
    $('#content' + name).css("visibility", 'hidden');
  }

  // Select the active tab.
  selected = clickedName;
  $('#tab' + clickedName).removeClass('taboff');
  $('#tab' + clickedName).addClass('tabon');
  $('#content' + clickedName).css("visibility", 'visible');

  renderContent(clickedName);

  if (clickedName == 'Blocks') {
    workspace.setVisible(true);
  }
  Blockly.svgResize(workspace);
}

function confirmLang(lang) {
    if (lang == null)  return "emoji";
    switch (lang) {
      case "ja":
      case "日本語":	return "ja";  
      case "simple_ja":
      case "にほんご": 	return "simple_ja";
      case "en":	return "en";
      default: 		return "emoji";
    }
}

var i18nMap = {
    "intro": { "ja": "ヘルプ", "en": "Help", "default": "&#x2753;" }
  , "openButton": { "ja": "読込", "en": "Open", "default": "&#x1f4c2;" }
  , "saveButton": { "ja": "保存", "en": "Save", "default": "&#x1f4be;"  }
  , "printButton": { "ja": "印刷", "en": "Print", "default": "&#x1f5a8;" }
  , "uploadXmlButton": { "ja": "データアップロード", "en": "Upload Data", "default": "&#x1f4c4;&#x1f4e4;" }
  , "uploadSvgButton": { "ja": "画像アップロード", "en": "Upload Image", "default": "&#x1f5bc;&#x1f4e4;" }
  , "resetButton": { "ja": "リセット", "en": "Reset", "default": "&#x21bb;" }
};

function replaceI18nElement(id, lang) {
   console.log(id, lang);
   var content = i18nMap[id][lang];
   if (content == null) content = i18nMap[id]["default"];
		      
   return content;
}

$(function() {
    workspace = Blockly.inject('contentBlock',
       { toolbox: document.getElementById('toolbox'),
         zoom: { controls: true, wheel: true, startScale: 1.0, maxScale: 3, minScale: 0.3, scaleSpeed: 1.2 }
       });

    BlocklyStorage.backupOnUnload(workspace);

    workspace.addChangeListener(Blockly.Events.disableOrphans);

    draw = SVG("contentSVG");

    var lang = confirmLang($.query.get("lang"));

    $(".i18n").html(function() {
        return replaceI18nElement($(this).attr("id"), lang);
    });

    var clean = $.query.get("clean");
    if (clean != null && (clean.toLowerCase() == "true" || clean.toLowerCase() == "yes")) {
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
    } else {
        window.setTimeout(function () {
//            BlocklyStorage.restoreBlocks(workspace);
              var url = window.location.href.split('#')[0];
              if ('localStorage' in window) {
                var memo = window.localStorage[url];
                if (memo) {
                    var xml = Blockly.Xml.textToDom(memo);
                    if (xml.hasChildNodes()) {
                        Blockly.Xml.domToWorkspace(xml, workspace);
                        return;
                    }
                    // xml が空だったら続行する
                }
              }
              var xmlUrl = $.query.get("url");
              if (xmlUrl) {
              	$.ajax({ url: xmlUrl, dataType: "text" }).done(function(data) {
              	    var xml = Blockly.Xml.textToDom(data);
              	    Blockly.Xml.domToWorkspace(xml, workspace);
              	});
              } else {
                Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
              }
        }, 0);
    }

//    $("#printButton").click(function () {
//       renderContent("SVG");
//       var subframe = $('#svgFrame');
//       console.log("abc", subframe[0].innerHTML, "xyz");
//       var blob    = new Blob([svgText], { type: 'image/svg+xml' });
//       var sub     = window.open(URL.createObjectURL(blob), 'SVG subwindow');
//    });

    $("#intro").click(function() {
//      alert("intro");
      var tour = introJs();
      tour.setOption('tooltipPosition', 'auto');
      tour.start();
      return false;
    });

    function printSVG() {
      var wid = draw.attr("width");
      var hei = draw.attr("height");
      draw.attr("width", BookCover.pageWidth() + "mm");
      draw.attr("height", BookCover.pageHeight() + "mm");
      var svgText = draw.svg();
      draw.attr("width", wid);
      draw.attr("height", hei);
      console.log(svgText);
      var blob    = new Blob([svgText], { type: 'image/svg+xml' });
      if (window.navigator && window.navigator.msSaveOrOpenBlob) {
         window.navigator.msSaveOrOpenBlob(blob);
      } else {
         var sub     = window.open(URL.createObjectURL(blob), 'SVG subwindow');
      }
      return false;
    }

    $("#printButton").click(function() {
      if (!$('#tabSVG').hasClass('tabon')) {
        renderSVG();
      }
      printSVG();
      return false;
    });

    $("#saveButton").click(function() {
       var xmlText;
       if ($('#tabXml').hasClass('tabon')) {
           xmlText = $('#contentXml').val();
       } else {
           var xmlDom  = Blockly.Xml.workspaceToDom(workspace);
           xmlText     = Blockly.Xml.domToPrettyText(xmlDom);
       }
       var blob    = new Blob([xmlText], { type: 'text/xml' });
       $("#saveButton").attr('href', window.URL.createObjectURL(blob));
    });
    $("#openButton").click(function() {
      $("#openButtonAux").click();
      return false;
    });
    $("#openButtonAux").change(function(evt) {
       var f = evt.target.files[0];
       var reader = new FileReader();

       reader.onload = function(e) {
         var xmlText = e.target.result;
         $("contentXml").val(xmlText);
         if (!$('#tabXml').hasClass('tabon')) {
           try {
             xmlDom = Blockly.Xml.textToDom(xmlText);
           } catch (e) {
             var q =
                 window.confirm(MSG['badXml'].replace('%1', e));
             if (!q) {
               // Leave the user on the XML tab.
               return;
             }
           }
           if (xmlDom) {
             workspace.clear();
             Blockly.Xml.domToWorkspace(xmlDom, workspace);
           }
         }
       };
       reader.readAsText(f);

    });

    $("#resetButton").click(function () {
        var q = window.confirm("編集したプログラムを捨てて、最初の内容に戻します。よろしいですか？");
        if (!q) return;
        var xmlUrl = $.query.get("url");
        if (xmlUrl) {
          $.ajax({ url: xmlUrl, dataType: "text" }).done(function(data) {
              workspace.clear();
              var xml = Blockly.Xml.textToDom(data);
              Blockly.Xml.domToWorkspace(xml, workspace);
          });
        } else {
           workspace.clear();
           Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
        }
    });

    var uploadUrl = $.query.get("upload");
    // uploadUrl は name と data というパラメーターをとると仮定する
    if (uploadUrl == null || uploadUrl == "") {
      $("#uploadXmlButton").hide();
      $("#uploadSvgButton").hide();
    } else {
      $("#uploadXmlButton").click(function() {
       	 var xmlText;
       	 if ($('#tabXml').hasClass('tabon')) {
       	     xmlText = $('#contentXml').val();
       	 } else {
       	     var xmlDom  = Blockly.Xml.workspaceToDom(workspace);
       	     xmlText     = Blockly.Xml.domToPrettyText(xmlDom);
       	 }
         $.ajax({ url: uploadUrl
		, data: ({ name: "blocks.xml", data: xmlText })
                , type: "post"
                , dataType: "text"
		}).done(function (message) {
                   console.log("success", message);
                   alert(message); // TODO alert ではなくて Chrome でもコピペできるようにする
                }).fail(function (message, status) {
                   console.log("fail", status);
                   alert(status);
                });
      });
      $("#uploadSvgButton").click(function() {
      	 if (!$('#tabSVG').hasClass('tabon')) {
      	   renderSVG();
      	 }
         var svgText = draw.svg();
         $.ajax({ url: uploadUrl
                , type: "post"
		        , data: ({ name: "blocks.svg", data: svgText })
                , dataType: "text"
		}).done(function (message) {
                   console.log("success", message);
                   alert(message); // TODO alert ではなくて Chrome でもコピペできるようにする
                }).fail(function (message, status) {
                   console.log("fail", status);
                   alert(status);
                });
      });
    }

    onResize();
    Blockly.svgResize(workspace);

    // 無理やりフォントを変更する。
    var cssNode = document.createElement('style');
    document.head.appendChild(cssNode);
    var text = ".blocklyText {"
      	     + "  cursor: default;"
      	     + "  fill: #fff;"
      	     + "  font-family: 'Segoe UI Symbol';"
      	     + "  font-size: 11pt;"
      	     + "}";
    var cssTextNode = document.createTextNode(text);
    cssNode.appendChild(cssTextNode);

    tabClick(selected);
    for (var i = 0; i < tabs.length; i++) {
       var name = tabs[i];
       $("#tab" + name).click(function(name_) { return function() { tabClick(name_); }; }(name));
    }
});
</script>
</body>
</html>

