<!DOCTYPE html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>BookCoverJS (CodeMirror)</title>
<link rel="shortcut icon" href="favicon.png" type="image/png"/>
<script src="3rdParty/codemirror/lib/codemirror.js"></script>
<link rel="stylesheet" href="3rdParty/codemirror/lib/codemirror.css" />
<script src="3rdParty/codemirror/mode/javascript/javascript.js"></script>
<script src="3rdParty/jquery-2.2.4.min.js"></script>
<script src="3rdParty/jquery.query.js"></script>
<script src="3rdParty/intro.js"></script>
<link rel="stylesheet" href="3rdParty/introjs.css" />
<script src="3rdParty/svg.js"></script>
<script src="BookCoverJS/BookCover.js"></script>
<style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: sans-serif;
      overflow: hidden;
    }
    table {
      height: 100%;
      width: 100%;
      border-collapse: collapse;
      margin: 0;
      padding: 0;
      border: none;
    }

    /* Tabs */
    #tabRow>td {
      border: 1px solid #ccc;
      border-bottom: none;
    }
    td.tabon {
      border-bottom-color: #ddd !important;
      background-color: #ddd;
      padding: 5px 19px;
    }
    td.taboff {
      cursor: pointer;
      padding: 5px 19px;
    }
    td.taboff:hover {
      background-color: #eee;
    }
    td.tabmin {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
    }
    td.tabmax {
      border-top-style: none !important;
      border-left-style: none !important;
      border-right-style: none !important;
      width: 99%;
      padding-left: 10px;
      padding-right: 10px;
      text-align: right;
    }

    .content {
      visibility: hidden;
      margin: 0;
      padding: 1ex;
      position: absolute;
      direction: ltr;
    }
    pre.content {
      border: 1px solid #ccc;
      overflow: scroll;
    }
    div.content {
      border: 1px solid #ccc;
      overflow: scroll;
    }

    .button_like {
      font-size: 70%;
      font-family: 'Segoe UI Emoji';
      padding: 3px 5px 3px 5px;
      text-align: center;
      text-decoration: none;
      border: 2px solid;
      border-color: #aaaaaa #444444 #444444 #aaaaaa;
      background: #dddddd;
    }

    .button_like:hover{
      background:#ccddff;
      border-color: #aaaacc #444466 #444466 #aaaacc;
    }

    .CodeMirror {
      height: auto; 
      overflow-y: hidden; 
      overflow-x: auto;
    }
</style>
</head>
<body>
<table>
<tr>
    <td>
       <table width='100%'>
          <tr id="tabRow" height="1em">
            <td id="tabJavaScript" class="taboff" style="white-space:nowrap;" data-step="1"
                data-intro="このタブをクリックして、プログラムを編集します。">JavaScript</td>
            <td class="tabmin">&nbsp;</td>
            <td id="tabSVG" class="taboff" style="white-space:nowrap;" data-step="2"
                data-intro="このタブをクリックして、絵を確認します。">絵</td>
            <td class="tabmax">
              <a href="#" id="intro" title="ヘルプ" class="i18n button_like">&#x2753;</a>
              <a href="#" id="openButton" title="読込み" class="i18n button_like" data-step="5"
                          data-intro="保存したプログラムを読み込みます。">&#x1f4c2;</a>
              <input type="file" id="openButtonAux" name="openButtonAux"  style="display:none;" />
              <a href="#" id="saveButton" download="mydesign.js" title="保存" class="i18n button_like" data-step="4"
                          data-intro="プログラムを保存します。">&#x1f4be;</a>
              <a href="#" id="printButton" title="印刷用ページ" class="i18n button_like" data-step="6"
                          data-intro="印刷用ページを開きます。">&#x1f5a8;</a>
              <a href="#" id="uploadSvgButton" title="絵をアップロード"
                          class="i18n button_like" data-step="8">&#x1f5bc;&#x1f4e4;</a>
              <a href="#" id="uploadSourceButton" title="プログラムをアップロード"
                          class="i18n button_like" data-step="8">&#x1f4c4;&#x1f4e4;</a>
              <a href="#" id="resetButton" title="リセット" class="i18n button_like" data-step="7"
                          data-intro="これまでの変更を捨てて、最初のプログラムに戻します。">&#x21bb;</a>
            </td>
          </tr>
       </table>
    </td>
</tr>
<tr>
  <td id="blocklyArea" style='border: 0pt; height: 99%;'>
  </td>
</tr>
</table>
<div id="contentJavaScript" class="content">
</div>
<div id="contentSVG" class="content" style="padding: 0ex;"></div>
<script>
var tabs = ["JavaScript", "SVG"];
var selected = tabs[0];
var draw;
var myCodeMirror;

function onResize() {
    var area = $("#blocklyArea");
    var divs = [$("#contentJavaScript"), $("#contentSVG") ];

    var width = area.width();
    var height = area.height();
    var offset = area.offset();
    for (var i = 0; i < divs.length ; i++) {
       var div = divs[i];
       div.height(height);
       div.width(width);
       div.offset(offset);
    }
}

$(window).on('load resize', onResize);

function renderSVG() {
  var code = myCodeMirror.getValue();
  draw.clear();
  eval(code);
}

function renderContent(clickedName) {
  var content = $("#content" + clickedName);
  if (clickedName == "JavaScript") {
  } else if (clickedName == "SVG") {
     renderSVG();
  }
}

function tabClick(clickedName) {
  // Deselect all tabs and hide all panes.
  for (var i = 0; i < tabs.length; i++) {
    var name = tabs[i];
    $('#tab' + name).removeClass('tabon');
    $('#tab' + name).addClass('taboff');
    $('#content' + name).css("visibility", 'hidden');
  }

  // Select the active tab.
  selected = clickedName;
  $('#tab' + clickedName).removeClass('taboff');
  $('#tab' + clickedName).addClass('tabon');
  $('#content' + clickedName).css("visibility", 'visible');

  renderContent(clickedName);
}

function backupJS() {
  if ('localStorage' in window) {
    var code = myCodeMirror.getValue();
    var url = window.location.href.split('#')[0];
    window.localStorage.setItem(url, code);
  }
}

$(window).on('unload', backupJS);

function restoreJS()  {
  var url = window.location.href.split('#')[0];
  if ('localStorage' in window && window.localStorage[url]) {
    var code = window.localStorage[url];
    myCodeMirror.setValue(code);
  }
}

function confirmLang(lang) {
    if (lang == null)  return "emoji";
    switch (lang) {
      case "ja":
      case "日本語":	return "ja";  
      case "simple_ja":
      case "にほんご": 	return "simple_ja";
      case "en":	return "en";
      default: 		return "emoji";
    }
}

var i18nMap = {
    "intro": { "ja": "ヘルプ", "en": "Help", "default": "&#x2753;" }
  , "openButton": { "ja": "読込", "en": "Open", "default": "&#x1f4c2;" }
  , "saveButton": { "ja": "保存", "en": "Save", "default": "&#x1f4be;"  }
  , "printButton": { "ja": "印刷", "en": "Print", "default": "&#x1f5a8;" }
  , "uploadSourceButton": { "ja": "ソースアップロード", "en": "Upload Data", "default": "&#x1f4c4;&#x1f4e4;" }
  , "uploadSvgButton": { "ja": "画像アップロード", "en": "Upload Image", "default": "&#x1f5bc;&#x1f4e4;" }
  , "resetButton": { "ja": "リセット", "en": "Reset", "default": "&#x21bb;" }
};

function replaceI18nElement(id, lang) {
   console.log(id, lang);
   var content = i18nMap[id][lang];
   if (content == null) content = i18nMap[id]["default"];
		      
   return content;
}

$(function() {
    draw = SVG("contentSVG");
    tabClick(selected);
    for (var i = 0; i < tabs.length; i++) {
       var name = tabs[i];
       $("#tab" + name).click(function(name_) { return function() { tabClick(name_); }; }(name));
    }

    var initCode = "var BC = BookCover;\n" +
		   "BC.start(draw);\n" +
                   "BC.pageFrame();\n" +
                   "  BC.stroke(null);\n" +
                   "  var i;\n" +
                   "  for (i = 0; i <= 330; i += 30) {\n" +
                   "    BC.fill(BC.hsl360(i, 100, 50));\n" +
                   "    BC.pushMatrix()\n" +
                   "      BC.translate(BC.pageWidth() / 2, BC.pageHeight() / 2);\n" +
                   "      BC.pushMatrix()\n" +
                   "        BC.rotate360(i);\n" +
                   "        BC.translate(80, 0);\n" +
                   "        BC.rect(-10, -10, 20, 20);\n" +
                   "      BC.popMatrix();\n" +
                   "    BC.popMatrix();\n" +
                   "  }\n" +
                   "BC.finish();\n";

    myCodeMirror = CodeMirror(function(elt) {
       $("#contentJavaScript").append($(elt));
    }, { lineNumbers: true
       , mode: "text/javascript"
       , value: "" });

    var lang = confirmLang($.query.get("lang"));

    $(".i18n").html(function() {
        return replaceI18nElement($(this).attr("id"), lang);
    });

    var clean = $.query.get("clean");
    if (clean != null && (clean.toLowerCase() == "true" || clean.toLowerCase() == "yes")) {
        myCodeMirror.setValue(initCode);
    } else {
        window.setTimeout(function () {
              var url = window.location.href.split('#')[0];
              if ('localStorage' in window) {
                var memo = window.localStorage[url];
                if (memo) {
                    myCodeMirror.setValue(memo);
		    return;
                    // memo が空だったら続行する
                }
              }
              var jsUrl = $.query.get("url");
              if (jsUrl) {
              	$.ajax({ url: jsUrl, dataType: "text" }).done(function(data) {
              	  myCodeMirror.setValue(data);
              	});
              } else {
                myCodeMirror.setValue(initCode);
              }
        }, 0);
    }

    $("#intro").click(function() {
//      alert("intro");
      var tour = introJs();
      tour.setOption('tooltipPosition', 'auto');
      tour.start();
      return false;
    });

    function printSVG() {
      var svgText = draw.svg();
      var blob    = new Blob([svgText], { type: 'image/svg+xml' });
      var sub     = window.open(URL.createObjectURL(blob), 'SVG subwindow');
      return false;
    }

    $("#printButton").click(function() {
      if (!$('#tabSVG').hasClass('tabon')) {
        renderSVG();
      }
      printSVG();
      return false;
    });

    $("#saveButton").click(function() {
       var code = myCodeMirror.getValue();
       var blob    = new Blob([code], { type: 'application/javascript' });
       $("#saveButton").attr('href', window.URL.createObjectURL(blob));
    });

    $("#openButton").click(function() {
      $("#openButtonAux").click();
      return false;
    });

    $("#openButtonAux").change(function(evt) {
       var f = evt.target.files[0];
       var reader = new FileReader();

       reader.onload = function(e) {
         var code = e.target.result;
         myCodeMirror.setValue(code);
         if (!$('#tabJavaScript').hasClass('tabon')) {
           renderSVG();
         }
       };
       reader.readAsText(f);
    });

    $("#resetButton").click(function () {
        var q = window.confirm("編集したプログラムを捨てて、最初の内容に戻します。よろしいですか？");
        if (!q) return;
        var jsUrl = $.query.get("url");
        if (jsUrl) {
          $.ajax({ url: jsUrl, dataType: "text" }).done(function(data) {
              myCodeMirror.setValue(data);
          });
        } else {
          myCodeMirror.setValue(initCode);
        }
    });

    var uploadUrl = $.query.get("upload");
    // uploadUrl は name と data というパラメーターをとると仮定する
    if (uploadUrl == null || uploadUrl == "") {
      $("#uploadSourceButton").hide();
      $("#uploadSvgButton").hide();
    } else {
      $("#uploadSourceButton").click(function() {
       	 var sourceText = myCodeMirror.getValue();
         $.ajax({ url: uploadUrl
		, data: ({ name: "myGraphics.js", data: sourceText })
                , type: "post"
                , dataType: "text"
		}).done(function (message) {
                   console.log("success", message);
                   alert(message); // TODO alert ではなくて Chrome でもコピペできるようにする
                }).fail(function (message, status) {
                   console.log("fail", status);
                   alert(status);
                });
      });
      $("#uploadSvgButton").click(function() {
      	 if (!$('#tabSVG').hasClass('tabon')) {
      	   renderSVG();
      	 }
         var svgText = draw.svg();
         $.ajax({ url: uploadUrl
                , type: "post"
		        , data: ({ name: "myGraphics.svg", data: svgText })
                , dataType: "text"
		}).done(function (message) {
                   console.log("success", message);
                   alert(message); // TODO alert ではなくて Chrome でもコピペできるようにする
                }).fail(function (message, status) {
                   console.log("fail", status);
                   alert(status);
                });
      });
    }
});
</script>
</body>
</html>
